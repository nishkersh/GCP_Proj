<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
<title>Definitive GCP & Zscaler Hub-Spoke Architecture (ZPA Admin Access)</title>
<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/cytoscape-cose-bilkent@4.0.0/cytoscape-cose-bilkent.js"></script>
<style>
  body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: 14px; 
    margin: 0; 
    padding: 0;
    background-color: #1a1a1a;
    color: #f8f9fa;
    overflow: hidden;
  }
  #cy {
    width: 100vw;
    height: 100vh;
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }
  .tooltip {
    position: absolute;
    background-color: rgba(20, 20, 20, 0.9);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 320px;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none;
    z-index: 100;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
  }
  .tooltip b {
    color: #69db7c;
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .packet {
    position: absolute;
    width: 2px;
    height: 2px;
    border-radius: 50%;
    z-index: 2;
    pointer-events: none;
    box-shadow: 0 0 2px .5px rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 1);
  }
  .packet-admin { background-color: #fab005; }
  .packet-user { background-color: #339af0; }
  .packet-egress { background-color: #f03e3e; }
  .packet-zpa { background-color: #2f9e44; }
  .packet-internal { background-color: #845ef7; }
  .packet-db { background-color: #e67700; }
  .packet-nat { background-color: #ced4da; }
</style>
</head>
<body>
  <div id="cy"></div>
  <div id="tooltip" class="tooltip"></div>

<script>
document.addEventListener('DOMContentLoaded', function(){

  cytoscape.use(cytoscapeCoseBilkent);

  var cy = cytoscape({
    container: document.getElementById('cy'),

    elements: [
      // --- Nodes ---
      { data: { id: 'internet', label: 'Public Internet\n(0.0.0.0/0)', type: 'internet', tooltip: '<b>The Global Network</b><br>Represents all traffic originating from or destined for the public internet.' } },
      { data: { id: 'gcp_project', label: 'GCP Project: it-devops-tf', type: 'container_project' } },
      { data: { id: 'hub_vpc', label: 'Hub VPC (zs-hub-vpc-dev)', parent: 'gcp_project', type: 'container_vpc' } },
      { data: { id: 'spoke_vpc', label: 'Spoke VPC (app-vpc)', parent: 'gcp_project', type: 'container_vpc' } },
      { data: { id: 'admin_user', label: 'Admin User', type: 'actor', tooltip: '<b>Persona:</b> DevOps/Admin<br><b>Access Method:</b> Zscaler Client Connector + SSH Client<br><b>Purpose:</b> Securely manages infrastructure via ZPA-brokered SSH.' } },
      { data: { id: 'app_user', label: 'Application Users', type: 'actor', tooltip: '<b>Persona:</b> End User<br><b>Access Method:</b> Web Browser (HTTPS)<br><b>Purpose:</b> Accesses the deployed application via the public ALB.' } },
      { data: { id: 'zpa_users', label: 'Remote ZPA Users', type: 'actor', tooltip: '<b>Persona:</b> Internal/Privileged User<br><b>Access Method:</b> Zscaler Client Connector<br><b>Purpose:</b> Securely accesses internal applications without a VPN.' } },
      { data: { id: 'zscaler_cloud', label: 'Zscaler Zero Trust Exchange', type: 'zscaler_cloud', tooltip: '<b>ZIA (Internet Access):</b> Applies security policy to all egress traffic from the Spoke.<br><b>ZPA (Private Access):</b> Brokers secure, zero-trust connections to internal apps AND administrative SSH sessions.' } },
      { data: { id: 'secret_manager', label: 'Secret Manager', type: 'gcp_security_service', tooltip: '<b>Service:</b> Google Secret Manager<br><b>Purpose:</b> Securely stores the ZPA Provider API credentials (client ID, secret, customer ID).' } },
      { data: { id: 'hub_mgmt_subnet', label: 'zs-hub-mgmt-subnet', parent: 'hub_vpc', type: 'container_subnet' } },
      { data: { id: 'hub_cc_subnet', label: 'zs-cc-subnet', parent: 'hub_vpc', type: 'container_subnet' } },
      // ZPA BASTION CHANGE: Updated tooltip to reflect private-only status.
      { data: { id: 'hub_bastion', label: 'Hub Bastion', parent: 'hub_mgmt_subnet', type: 'gcp_compute', tooltip: '<b>Role:</b> Private Management Host<br>A private-only VM for managing Hub resources. Accessed securely via ZPA-brokered SSH.' } },
      { data: { id: 'hub_nat', label: 'Hub NAT Gateway', parent: 'hub_vpc', type: 'gcp_networking', tooltip: '<b>Role:</b> Egress Gateway<br>Provides outbound internet access for private resources in the Hub VPC, like the bastion and connectors for OS updates.' } },
      { data: { id: 'cc_ilb', label: 'Cloud Connector ILB', parent: 'hub_cc_subnet', type: 'gcp_loadbalancer', tooltip: '<b>Role:</b> Egress Traffic Forwarder<br>Internal Load Balancer for Cloud Connector HA. It is the next-hop target for all internet-bound traffic from the Spoke VPC.' } },
      { data: { id: 'cc_vms', label: 'Cloud Connector VMs (HA)', parent: 'hub_cc_subnet', type: 'zscaler_connector', tooltip: '<b>Role:</b> Egress Security Enforcement<br>Inspects and forwards egress traffic to the Zscaler Internet Access (ZIA) cloud.' } },
      { data: { id: 'spoke_mgmt_subnet', label: 'mgmt-subnet', parent: 'spoke_vpc', type: 'container_subnet' } },
      { data: { id: 'gke_subnet', label: 'gke-subnet', parent: 'spoke_vpc', type: 'container_subnet' } },
      { data: { id: 'db_subnet', label: 'db-subnet', parent: 'spoke_vpc', type: 'container_subnet' } },
      { data: { id: 'ac_subnet', label: 'zs-ac-subnet', parent: 'spoke_vpc', type: 'container_subnet' } },
      { data: { id: 'spoke_bastion', label: 'Spoke Bastion', parent: 'spoke_mgmt_subnet', type: 'gcp_compute', tooltip: '<b>Role:</b> Private Management Host<br>A private-only VM used to run `kubectl` against the GKE private control plane. Accessed securely via ZPA-brokered SSH.' } },
      { data: { id: 'spoke_nat', label: 'Spoke NAT Gateway', parent: 'spoke_vpc', type: 'gcp_networking', tooltip: '<b>Role:</b> Egress Gateway<br>Provides outbound internet for the private Spoke Bastion for OS updates.' } },
      { data: { id: 'cloud_sql', label: 'Cloud SQL DB', parent: 'db_subnet', type: 'gcp_database', tooltip: '<b>Role:</b> Application Database<br>Private PostgreSQL instance. Only accessible from within the Spoke VPC.' } },
      { data: { id: 'app_connectors', label: 'App Connector VMs (HA)', parent: 'ac_subnet', type: 'zscaler_connector', tooltip: '<b>Role:</b> Ingress Access Proxy<br>Establishes outbound tunnels to the ZPA cloud and provides reverse-access to GKE applications AND bastion hosts for authenticated ZPA users.' } },
      { data: { id: 'alb', label: 'Application LB (ALB)', parent: 'spoke_vpc', type: 'gcp_loadbalancer', tooltip: '<b>Role:</b> Public Ingress<br>Global HTTPS Load Balancer that exposes the application to the public internet.' } },
      { data: { id: 'alb_negs', label: 'ALB NEGs', parent: 'spoke_vpc', type: 'gcp_networking', tooltip: '<b>Role:</b> Backend Pointer<br>Network Endpoint Groups that link the ALB to specific services running inside the GKE cluster.' } },
      { data: { id: 'gke_cluster', label: 'GKE Cluster', parent: 'gke_subnet', type: 'gcp_gke', tooltip: '<b>Role:</b> Application Platform<br>Hosts the containerized application tiers. Configured with a private control plane.' } },
      { data: { id: 'k8s_frontend', label: 'Frontend Pods/Service', parent: 'gke_cluster', type: 'k8s_app', tooltip: '<b>Tier:</b> Presentation<br>Serves the user interface. Exposed to the internet via the ALB.' } },
      { data: { id: 'k8s_backend', label: 'Backend Pods/Service', parent: 'gke_cluster', type: 'k8s_app', tooltip: '<b>Tier:</b> Business Logic<br>Handles API requests and communicates with the database. Not directly exposed to the internet.' } },

      // --- Edges (Connections) ---
      // ZPA BASTION CHANGE: Admin access flow is completely rerouted through ZPA.
      { data: { id: 'e_admin_zpa', source: 'admin_user', target: 'zscaler_cloud', label: '1. SSH Request', type: 'flow_admin', tooltip: '<b>ZPA Admin Access (Step 1):</b> Admin initiates SSH to an internal FQDN (e.g., hub-bastion.zscaler.internal). The Zscaler Client Connector intercepts it.' } },
      { data: { id: 'e_zpa_ac_admin', source: 'zscaler_cloud', target: 'app_connectors', label: '2. Broker Connection', type: 'flow_admin', tooltip: '<b>ZPA Admin Access (Step 2):</b> ZPA authenticates the user, checks policy, and instructs the correct App Connector to establish the connection.' } },
      { data: { id: 'e_ac_hub_bastion', source: 'app_connectors', target: 'hub_bastion', label: '3. Proxied SSH (Private)', type: 'flow_admin_internal', tooltip: '<b>ZPA Admin Access (Step 3):</b> The App Connector proxies the SSH connection to the Hub Bastion\'s private IP across the VPC peering.' } },
      { data: { id: 'e_ac_spoke_bastion', source: 'app_connectors', target: 'spoke_bastion', label: '3. Proxied SSH (Private)', type: 'flow_admin_internal', tooltip: '<b>ZPA Admin Access (Step 3):</b> The App Connector proxies the SSH connection directly to the Spoke Bastion\'s private IP.' } },
      
      { data: { id: 'e_spoke_bastion_gke', source: 'spoke_bastion', target: 'gke_cluster', label: 'kubectl (Private Endpoint)', type: 'flow_admin_internal', tooltip: '<b>GKE Management:</b> Admin runs `kubectl` commands from the Spoke Bastion, which can reach the GKE cluster\'s private control plane.' } },
      { data: { id: 'e_spoke_bastion_db', source: 'spoke_bastion', target: 'cloud_sql', label: 'psql (Private IP)', type: 'flow_admin_internal', tooltip: '<b>Database Management:</b> Admin runs `psql` or other DB tools from the Spoke Bastion to connect to the Cloud SQL private IP.' } },
      
      { data: { id: 'e_internet_user', source: 'internet', target: 'app_user', label: 'User Traffic', type: 'flow_user' } },
      { data: { id: 'e_appuser_alb', source: 'app_user', target: 'alb', label: 'HTTPS (Port 443)', type: 'flow_user', tooltip: '<b>Public Application Access:</b> Users access the application via its public domain name, hitting the Global ALB.' } },
      { data: { id: 'e_alb_negs', source: 'alb', target: 'alb_negs', label: 'Routes to NEG', type: 'flow_internal', tooltip: '<b>ALB Backend Routing:</b> The ALB forwards traffic to the Network Endpoint Group associated with the frontend Kubernetes service.' } },
      { data: { id: 'e_negs_frontend', source: 'alb_negs', target: 'k8s_frontend', label: 'Targets Frontend Pods', type: 'flow_internal', tooltip: '<b>NEG to Pods:</b> The NEG dynamically tracks the IPs of the healthy frontend pods and sends traffic to them.' } },
      { data: { id: 'e_frontend_backend', source: 'k8s_frontend', target: 'k8s_backend', label: 'Internal API Calls', type: 'flow_internal', tooltip: '<b>Internal Service Communication:</b> The frontend makes API calls to the backend using its internal Kubernetes service name (e.g., `backend-service.default.svc.cluster.local`).' } },
      { data: { id: 'e_backend_db', source: 'k8s_backend', target: 'cloud_sql', label: 'SQL Queries (Private IP)', type: 'flow_db', tooltip: '<b>Database Connection:</b> The backend connects to the Cloud SQL instance over its private IP within the VPC.' } },
      { data: { id: 'e_peering', source: 'hub_vpc', target: 'spoke_vpc', label: 'VPC Peering', type: 'flow_peering', tooltip: '<b>Hub & Spoke Peering:</b> Connects the two VPCs, allowing private IP communication between them.' } },
      { data: { id: 'e_gke_ilb', source: 'gke_cluster', target: 'cc_ilb', label: 'Default Route (0.0.0.0/0)', type: 'flow_egress', tooltip: '<b>Egress Interception:</b> A route in the Spoke VPC directs all internet-bound traffic from GKE to the Cloud Connector ILB in the Hub VPC.' } },
      { data: { id: 'e_ilb_cc', source: 'cc_ilb', target: 'cc_vms', label: 'Forwards to Healthy CC', type: 'flow_internal', tooltip: '<b>Load Balancing:</b> The ILB distributes the egress traffic across the available Cloud Connector VMs.' } },
      { data: { id: 'e_cc_zia', source: 'cc_vms', target: 'zscaler_cloud', label: 'Inspect & Forward to ZIA', type: 'flow_egress', tooltip: '<b>ZIA Egress Tunnel:</b> The Cloud Connector applies security policy and forwards the traffic to the Zscaler cloud for secure internet access.' } },
      { data: { id: 'e_zia_internet', source: 'zscaler_cloud', target: 'internet', label: 'Secure Internet Access', type: 'flow_egress' } },
      { data: { id: 'e_zpauser_cloud', source: 'zpa_users', target: 'zscaler_cloud', label: '1. Authenticate to ZPA', type: 'flow_zpa', tooltip: '<b>ZPA Authentication:</b> A remote user with the Zscaler client authenticates to the ZPA service.' } },
      { data: { id: 'e_cloud_ac', source: 'zscaler_cloud', target: 'app_connectors', label: '2. Establish Micro-Tunnel', type: 'flow_zpa', tooltip: '<b>ZPA Connection Brokering:</b> ZPA finds the correct App Connector and establishes a secure, inside-out micro-tunnel.' } },
      { data: { id: 'e_ac_backend', source: 'app_connectors', target: 'k8s_backend', label: '3. Proxy to Backend API', type: 'flow_zpa', tooltip: '<b>Proxied Application Access:</b> The App Connector proxies the user\'s request directly to the internal backend service, never exposing it to the internet.' } },
      { data: { id: 'e_hub_bastion_nat', source: 'hub_bastion', target: 'hub_nat', label: 'OS Updates, etc.', type: 'flow_nat', tooltip: '<b>Hub NAT Egress:</b> The private Hub Bastion uses the NAT Gateway for outbound internet access (e.g., `apt-get update`).' } },
      { data: { id: 'e_spoke_bastion_nat', source: 'spoke_bastion', target: 'spoke_nat', label: 'OS Updates, etc.', type: 'flow_nat', tooltip: '<b>Spoke NAT Egress:</b> The private Spoke Bastion uses the NAT Gateway for outbound internet access.' } },
      { data: { id: 'e_hub_nat_internet', source: 'hub_nat', target: 'internet', label: 'NAT Egress', type: 'flow_nat' } },
      { data: { id: 'e_spoke_nat_internet', source: 'spoke_nat', target: 'internet', label: 'NAT Egress', type: 'flow_nat' } },
      { data: { id: 'e_ac_secret', source: 'app_connectors', target: 'secret_manager', label: 'Reads API Key', type: 'flow_secure_access', tooltip: '<b>Secure Credential Fetch:</b> The App Connector module\'s Terraform provider configuration reads the ZPA API credentials from Secret Manager during `plan`/`apply`.' } },
      { data: { id: 'e_cc_provision', source: 'cc_vms', target: 'zscaler_cloud', label: 'Provisioning', type: 'flow_provisioning', tooltip: '<b>Cloud Connector Enrollment:</b> On startup, the CC VMs use a provisioning URL to enroll with the ZIA cloud.' } },
      { data: { id: 'e_ac_provision', source: 'app_connectors', target: 'zscaler_cloud', label: 'Provisioning', type: 'flow_provisioning', tooltip: '<b>App Connector Enrollment:</b> On startup, the AC VMs use a unique provisioning key to enroll with the ZPA cloud.' } },
    ],

    style: [
      { selector: 'node', style: { 'label': 'data(label)', 'text-valign': 'center', 'text-halign': 'center', 'font-size': '14px', 'text-wrap': 'wrap', 'text-max-width': '120px', 'background-color': '#ffffff', 'border-width': 2, 'border-color': '#adb5bd', 'shape': 'round-rectangle', 'width': 'label', 'height': 'label', 'padding': '14px', 'color': '#212529' }},
      { selector: 'edge', style: { 'width': 2.5, 'line-color': '#495057', 'target-arrow-color': '#495057', 'target-arrow-shape': 'triangle-backcurve', 'curve-style': 'bezier', 'label': 'data(label)', 'font-size': '12px', 'color': '#dee2e6', 'text-rotation': 'autorotate', 'text-background-opacity': 0.85, 'text-background-color': '#1a1a1a', 'text-background-padding': '3px', 'edge-text-rotation': 'autorotate' }},
      { selector: ':parent', style: { 'text-valign': 'top', 'text-halign': 'center', 'text-margin-y': '-15px', 'font-weight': 'bold', 'font-size': '18px', 'color': '#f8f9fa' }},
      { selector: 'node:selected', style: { 'border-color': '#fcc419', 'border-width': 4, 'box-shadow': '0 0 20px #fcc419' }},
      { selector: 'edge:selected', style: { 'line-color': '#fcc419', 'target-arrow-color': '#fcc419', 'width': 5 }},
      { selector: "node[type='internet']", style: { 'shape': 'cloud', 'background-color': '#343a40', 'border-color': '#495057', 'font-size': '18px', 'color': '#f8f9fa', 'padding': '20px' }},
      { selector: "node[type='container_project']", style: { 'background-color': '#212529', 'border-color': '#495057', 'font-size': '22px', 'border-style': 'solid' }},
      { selector: "node[type='container_vpc']", style: { 'background-color': '#343a40', 'border-color': '#868e96', 'font-size': '18px', 'border-style': 'dashed' }},
      { selector: "node[type='container_subnet']", style: { 'background-color': '#495057', 'border-color': '#868e96', 'font-size': '12px', 'font-weight': 'normal', 'text-valign': 'bottom', 'text-margin-y': '10px', 'border-style': 'dotted', 'color': '#ced4da' }},
      { selector: "node[type='actor']", style: { 'shape': 'ellipse', 'background-color': '#1864ab', 'border-color': '#4dabf7', 'color': '#e7f5ff' }},
      { selector: "node[type='zscaler_cloud']", style: { 'shape': 'diamond', 'background-color': '#e67700', 'border-color': '#fab005', 'color': '#fff' }},
      { selector: "node[type='zscaler_connector']", style: { 'background-color': '#f76707', 'border-color': '#ffc078' }},
      { selector: "node[type='gcp_compute']", style: { 'background-color': '#c2255c', 'border-color': '#f783ac' }},
      { selector: "node[type='gcp_gke']", style: { 'background-color': '#2b8a3e', 'border-color': '#69db7c' }},
      { selector: "node[type='k8s_app']", style: { 'background-color': '#5c940d', 'border-color': '#a9e34b' }},
      { selector: "node[type='gcp_database']", style: { 'background-color': '#7048e8', 'border-color': '#b197fc' }},
      { selector: "node[type='gcp_networking']", style: { 'shape': 'hexagon', 'background-color': '#364fc7', 'border-color': '#748ffc' }},
      { selector: "node[type='gcp_loadbalancer']", style: { 'shape': 'diamond', 'background-color': '#4263eb', 'border-color': '#91a7ff' }},
      { selector: "node[type='gcp_security_service']", style: { 'shape': 'vee', 'background-color': '#c92a2a', 'border-color': '#ff8787' }},
      { selector: "edge[type='flow_admin']", style: { 'line-color': '#fab005', 'target-arrow-color': '#fab005', 'width': 3 }},
      { selector: "edge[type='flow_admin_internal']", style: { 'line-color': '#fcc419', 'target-arrow-color': '#fcc419', 'line-style': 'dashed' }},
      { selector: "edge[type='flow_user']", style: { 'line-color': '#339af0', 'target-arrow-color': '#339af0', 'width': 3 }},
      { selector: "edge[type='flow_peering']", style: { 'line-color': '#5c940d', 'target-arrow-color': '#5c940d', 'line-style': 'solid', 'width': 4, 'target-arrow-shape': 'diamond', 'source-arrow-shape': 'diamond', 'source-arrow-color': '#5c940d' }},
      { selector: "edge[type='flow_egress']", style: { 'line-color': '#f03e3e', 'target-arrow-color': '#f03e3e', 'width': 3 }},
      { selector: "edge[type='flow_zpa']", style: { 'line-color': '#2f9e44', 'target-arrow-color': '#2f9e44', 'width': 3 }},
      { selector: "edge[type='flow_internal']", style: { 'line-color': '#845ef7', 'target-arrow-color': '#845ef7' }},
      { selector: "edge[type='flow_db']", style: { 'line-color': '#e67700', 'target-arrow-color': '#e67700' }},
      { selector: "edge[type='flow_nat']", style: { 'line-color': '#ced4da', 'target-arrow-color': '#ced4da', 'line-style': 'dotted', 'width': 3 }},
      { selector: "edge[type='flow_secure_access']", style: { 'line-color': '#c92a2a', 'target-arrow-color': '#c92a2a', 'line-style': 'dotted', 'width': 3 }},
      { selector: "edge[type='flow_provisioning']", style: { 'line-color': '#be4bdb', 'target-arrow-color': '#be4bdb', 'line-style': 'dotted' }},
    ],

    layout: {
      name: 'cose-bilkent',
      animate: 'end',
      animationEasing: 'ease-out',
      animationDuration: 1500,
      randomize: true,
      idealEdgeLength: 200,
      nodeRepulsion: 25000,
      nodeOverlap: 40,
      edgeElasticity: 0.45,
      nestingFactor: 0.1,
      gravity: 0.25,
      numIter: 3000,
      tile: true,
      tilingPaddingVertical: 30,
      tilingPaddingHorizontal: 30,
    }
  });

  // --- Packet Animation Logic ---
  const connectionsToAnimate = [
    // ZPA BASTION CHANGE: New admin flow is animated.
    { id: 'e_admin_zpa', type: 'admin', duration: 6000 },
    { id: 'e_zpa_ac_admin', type: 'admin', duration: 6000 },
    { id: 'e_ac_hub_bastion', type: 'admin', duration: 6000 },
    { id: 'e_ac_spoke_bastion', type: 'admin', duration: 6500 },
    
    { id: 'e_spoke_bastion_gke', type: 'admin', duration: 6000 },
    { id: 'e_spoke_bastion_db', type: 'admin', duration: 6500 },
    { id: 'e_internet_user', type: 'user', duration: 6000 },
    { id: 'e_appuser_alb', type: 'user', duration: 6000 },
    { id: 'e_alb_negs', type: 'user', duration: 6000 },
    { id: 'e_negs_frontend', type: 'user', duration: 6000 },
    { id: 'e_frontend_backend', type: 'internal', duration: 6500 },
    { id: 'e_backend_db', type: 'db', duration: 6000 },
    { id: 'e_gke_ilb', type: 'egress', duration: 6000 },
    { id: 'e_ilb_cc', type: 'egress', duration: 6000 },
    { id: 'e_cc_zia', type: 'egress', duration: 6000 },
    { id: 'e_zia_internet', type: 'egress', duration: 6000 },
    { id: 'e_zpauser_cloud', type: 'zpa', duration: 6500 },
    { id: 'e_cloud_ac', type: 'zpa', duration: 6500 },
    { id: 'e_ac_backend', type: 'zpa', duration: 6000 },
    { id: 'e_hub_bastion_nat', type: 'nat', duration: 6000 },
    { id: 'e_spoke_bastion_nat', type: 'nat', duration: 6500 },
    { id: 'e_hub_nat_internet', type: 'nat', duration: 6000 },
    { id: 'e_spoke_nat_internet', type: 'nat', duration: 6500 },
    { id: 'e_cc_provision', type: 'provisioning', duration: 6000 },
    { id: 'e_ac_provision', type: 'provisioning', duration: 6500 },
  ];

  const packets = {};

  function setupPackets() {
    connectionsToAnimate.forEach(conn => {
      const packet = document.createElement('div');
      packet.classList.add('packet', `packet-${conn.type}`);
      document.body.appendChild(packet);
      packets[conn.id] = {
        el: packet,
        duration: conn.duration,
        startTime: Date.now() + Math.random() * conn.duration
      };
    });
  }

  function animatePackets() {
    const now = Date.now();
    for (const connId in packets) {
      const edge = cy.getElementById(connId);
      const packetInfo = packets[connId];
      if (!edge.length || !edge.source().renderedPosition() || !edge.target().renderedPosition()) {
        continue;
      }
      let progress = ((now - packetInfo.startTime) % packetInfo.duration) / packetInfo.duration;
      const sourcePos = edge.source().renderedPosition();
      const targetPos = edge.target().renderedPosition();
      const x = sourcePos.x + (targetPos.x - sourcePos.x) * progress;
      const y = sourcePos.y + (targetPos.y - sourcePos.y) * progress;
      packetInfo.el.style.transform = `translate3d(${x - 1}px, ${y - 1}px, 0)`;
    }
    requestAnimationFrame(animatePackets);
  }

  // Tooltip Functionality
  const tooltipDiv = document.getElementById('tooltip');
  cy.on('mouseover', 'node, edge', function(evt){
    const element = evt.target;
    const tooltipText = element.data('tooltip');
    if (tooltipText) {
      tooltipDiv.innerHTML = tooltipText.replace(/\n/g, '<br>');
      tooltipDiv.style.opacity = '0.95';
      positionTooltip(evt);
    }
  });
  cy.on('mouseout', 'node, edge', function(evt){ tooltipDiv.style.opacity = '0'; });
  cy.on('mousemove', function(evt){ if (parseFloat(tooltipDiv.style.opacity) > 0) { positionTooltip(evt); }});
  function positionTooltip(evt) {
    tooltipDiv.style.left = evt.renderedPosition.x + 25 + 'px';
    tooltipDiv.style.top = evt.renderedPosition.y + 25 + 'px';
  }

  // Start the animation logic only after the layout is complete.
  cy.on('layoutstop', function() {
    setupPackets();
    animatePackets();
  });

});
</script>

</body>
</html>